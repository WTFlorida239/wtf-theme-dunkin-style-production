{% comment %}
  Enhanced Drink Builder – WTF | Welcome To Florida
  - Size: Medium, Large, Gallon
  - Live price preview
  - Strains: Green / Red / White / Yellow (max 2; supports ½+½)
  - Flavors w/ pump counters + category (Regular / Sugar-Free)
  - Gallon logic + THC selector when applicable
  - Saves all choices as line item properties
{% endcomment %}

{% liquid
  assign builder_product = product
  if builder_product == blank and section.settings.product != blank
    assign builder_product = section.settings.product
  endif
  if builder_product == blank and page and page.metafields.wtf.product_handle != blank
    assign builder_product = all_products[page.metafields.wtf.product_handle]
  endif

  assign builder_has_product = builder_product != blank
  if builder_has_product
    assign builder_variant = builder_product.selected_or_first_available_variant
    assign builder_included_pumps = builder_product.metafields.custom.included_pumps | default: 4
    assign builder_extra_pump_price = builder_product.metafields.custom.extra_pump_price | default: 0.50
    assign builder_max_flavors = builder_product.metafields.custom.max_flavors | default: 3

    assign builder_size_option = blank
    for opt in builder_product.options_with_values
      if builder_size_option == blank
        assign builder_size_option = opt
      endif
      if opt.name == 'Size'
        assign builder_size_option = opt
        break
      endif
    endfor

    assign builder_size_position = builder_size_option.position | default: 1
  endif
%}

<section
  id="enhanced-drink-builder"
  class="wtf-builder"
  aria-labelledby="builder-title"
  {% if builder_has_product %}
    data-product-id="{{ builder_product.id }}"
    data-size-position="{{ builder_size_position }}"
  {% endif %}
>
  <h2 id="builder-title">{{ section.settings.title | default: 'Build your drink' }}</h2>

  {% if builder_has_product %}
    {%- assign included_pumps = builder_included_pumps -%}
    {%- assign extra_pump_price = builder_extra_pump_price -%}
    {%- assign max_flavors = builder_max_flavors -%}

  <form
    id="builder-form-{{ builder_product.id }}"
    method="post"
    action="/cart/add"
    data-product-form
    role="form"
    aria-describedby="builder-help"
  >
    <input
      type="hidden"
      name="id"
      id="builder-variant-id"
      value="{{ builder_variant.id }}"
    >

    <!-- Live price -->
    <div class="price-row" aria-live="polite">
      <span class="current-price" id="builder-price">{{ builder_variant.price | default: builder_product.price | money }}</span>
      <span class="upsell-hint" id="builder-upsell"></span>
    </div>

    <!-- Size (variants) -->
    <fieldset class="wtf-db__group" style="margin-bottom:1rem;">
      <legend class="wtf-db__legend">Size</legend>
      {% if builder_size_option and builder_size_option.values.size > 0 %}
        <div class="wtf-db__chips chip-row" role="radiogroup" aria-label="Choose size">
        {% liquid
          assign option_key = 'option' | append: builder_size_position
        %}
        {%- for value in builder_size_option.values -%}
          {% liquid
            assign chip_id = 'size-' | append: section.id | append: '-' | append: forloop.index
            assign matched_variant = blank

            for v in builder_product.variants
              if v[option_key] == value and v.available
                assign matched_variant = v
                break
              endif
            endfor
            if matched_variant == blank
              for v in builder_product.variants
                if v[option_key] == value
                  assign matched_variant = v
                  break
                endif
              endfor
            endif

            assign variant_id = matched_variant.id
            assign variant_price_cents = matched_variant.price | default: 0
            assign variant_price_decimal = variant_price_cents | divided_by: 100.0
            assign is_checked = false
            if builder_variant and matched_variant and matched_variant.id == builder_variant.id
              assign is_checked = true
            elsif builder_variant == blank and forloop.first
              assign is_checked = true
            endif
          %}
          <label class="chip" for="{{ chip_id }}" style="display:inline-block;margin:.25rem .5rem .25rem 0;">
            <input
              type="radio"
              id="{{ chip_id }}"
              name="size"
              value="{{ value | escape }}"
              data-variant-id="{{ variant_id }}"
              data-price="{{ variant_price_decimal }}"
              data-price-cents="{{ variant_price_cents }}"
              {% unless matched_variant and matched_variant.available %}data-available="false"{% endunless %}
              {% if is_checked %}checked{% endif %}
            />
            <span>{{ value }}</span>
          </label>
        {%- endfor -%}
        </div>
      {% else %}
        <p class="wtf-db__notice" role="alert">Add a <strong>Size</strong> option to this product to enable the builder.</p>
      {% endif %}
      <input type="hidden" name="properties[Size]" id="prop-size" value="">
    </fieldset>

    <!-- Strains (max 2; ½+½ supported) -->
    <fieldset>
      <legend>Strain (up to 2)</legend>
      <div class="chip-row" aria-label="Choose up to two strains">
        {% assign strains = 'Green,Red,White,Yellow' | split: ',' %}
        {% for s in strains %}
          <label class="chip">
            <input type="checkbox" name="strain" value="{{ s }}">
            {{ s }}
          </label>
        {% endfor %}
      </div>
      <input type="hidden" name="properties[Strain]" id="prop-strain" value="">
    </fieldset>

    <!-- THC concentration (only when product has thc variant metafield & Gallon is selected) -->
    {% if builder_product.metafields.custom.thc_variant_id %}
      <fieldset id="thc-fieldset" hidden>
        <legend>THC concentration</legend>
        <div class="chip-row" role="radiogroup" aria-label="THC concentration">
          <label class="chip"><input type="radio" name="thc" value="Low">Low</label>
          <label class="chip"><input type="radio" name="thc" value="Medium">Medium</label>
          <label class="chip"><input type="radio" name="thc" value="High">High</label>
        </div>
        <input type="hidden" name="properties[THC Concentration]" id="prop-thc" value="">
      </fieldset>
    {% endif %}

    <!-- Flavors (category + pumps) -->
    <fieldset>
      <legend>Flavors</legend>

      {% comment %} If you have a snippet with your exact lists, render it. {% endcomment %}
      {% render 'wtf-flavor-options' %}
      {% comment %} If that snippet is missing, the JS will still allow manual entry via the search + chips UI you can add later. {% endcomment %}

      <div
        class="pump-meta small-text"
        id="pump-meta"
        data-included="{{ included_pumps }}"
        data-extra="{{ extra_pump_price }}"
        data-maxflavors="{{ max_flavors }}"
      >
        Included pumps: <strong>{{ included_pumps }}</strong>. Extra pump:
        <strong>{{ extra_pump_price | money }}</strong>.
      </div>
      <input type="hidden" name="properties[Flavors]" id="prop-flavors" value="">
      <input type="hidden" name="properties[Flavor Category]" id="prop-flavor-category" value="">
      <input type="hidden" name="properties[Flavor Pump Detail]" id="prop-pumps" value="">
    </fieldset>

    <!-- Boosters / Sweeteners / Creamers -->
    {% if section.settings.show_boosters %}
      <fieldset>
        <legend>Boosters</legend>
        <div class="chip-row">
          {% for b in section.blocks | where: 'type', 'booster' %}
            <label class="chip"
              ><input type="checkbox" name="booster" value="{{ b.settings.label | escape }}">{{ b.settings.label -}}
            </label>
          {% endfor %}
        </div>
        <input type="hidden" name="properties[Boosters]" id="prop-boosters" value="">
      </fieldset>
    {% endif %}

    <fieldset>
      <legend>Sweeteners</legend>
      <div class="chip-row">
        <label class="chip"><input type="checkbox" name="sweetener" value="Simple Syrup">Simple Syrup</label>
        <label class="chip"><input type="checkbox" name="sweetener" value="Stevia">Stevia</label>
        <label class="chip"
          ><input type="checkbox" name="sweetener" value="Sugar-Free Vanilla">Sugar-Free Vanilla</label
        >
      </div>
      <input type="hidden" name="properties[Sweeteners]" id="prop-sweeteners" value="">
    </fieldset>

    <fieldset>
      <legend>Creamers</legend>
      <div class="chip-row">
        <label class="chip"><input type="checkbox" name="creamer" value="Half & Half">Half &amp; Half</label>
        <label class="chip"><input type="checkbox" name="creamer" value="Oat Milk">Oat Milk</label>
        <label class="chip"><input type="checkbox" name="creamer" value="Almond Milk">Almond Milk</label>
      </div>
      <input type="hidden" name="properties[Creamers]" id="prop-creamers" value="">
    </fieldset>

    <!-- Gallon message -->
    <p id="gallon-note" class="small-text" hidden>
      For Gallons of Kratom or Kava, flavors are discussed with staff at pickup.
    </p>

    <!-- Error Display -->
    <div data-product-form-error class="form-error" hidden>
      <p class="error-message" role="alert"></p>
    </div>

    <!-- Submit -->
    <button type="submit" class="btn btn-primary" id="builder-add">Add to cart</button>

    <!-- Helper -->
    <p id="builder-help" class="visually-hidden">
      Use the chips to choose options. You can select up to two strains and a limited number of flavor pumps per size.
    </p>
  </form>

  <!-- Pass variant data to JS -->
  <script type="application/json" id="builder-variants-{{ builder_product.id }}">
    {{ builder_product.variants | json }}
  </script>
  {% comment %}
    Note: The product form above includes data-product-form which our global.js
    uses to intercept and perform an AJAX add-to-cart. This ensures the cart
    drawer opens without a page reload when enabled.
  {% endcomment %}
  {% else %}
    <div class="page-width" style="max-width:680px;margin:2rem auto 0;">
      <div class="wtf-db__empty" role="status">
        <p style="margin:0;font-weight:600;">Assign a product to this builder section.</p>
        <p style="margin:0.5rem 0 0;color:rgba(0,0,0,.6);">
          Select a product in the section settings or set the <code>wtf.product_handle</code> metafield on this page.
        </p>
      </div>
    </div>
  {% endif %}
</section>

{% schema %}
{
  "name": "Enhanced Drink Builder",
  "templates": ["product", "page"],
  "settings": [
    { "type": "text", "id": "title", "label": "Heading", "default": "Build your drink" },
    { "type": "checkbox", "id": "show_boosters", "label": "Show boosters", "default": true },
    { "type": "product", "id": "product", "label": "Product (for Pages)" },

    { "type": "select", "id": "product_kind", "label": "Product kind (for Gallon logic)", "default": "auto",
      "options": [
        { "value": "auto", "label": "Auto-detect from product tags" },
        { "value": "kratom", "label": "Kratom" },
        { "value": "kava", "label": "Kava" },
        { "value": "delta9", "label": "Delta-9" }
      ]
    },

    { "type": "header", "content": "Flavor lists" },
    { "type": "textarea", "id": "sugar_free_flavors", "label": "Sugar-free flavors (one per line)",
      "default": "Blackberry\nWhite Chocolate\nPumpkin Spice\nLemon Spritz\nVanilla\nMaple Bourbon Pecan\nPeach\nSimple Syrup\nCosmopolitain\nRaspberry Lemonade\nPomegranate\nBlueberry Lavender\nSalted Caramel\nRose\nMexican Chocolate"
    },
    { "type": "textarea", "id": "regular_flavors", "label": "Regular-sugar flavors (one per line)",
      "default": "Caramel Apple Butter\nLime\nGrenadine\nDark Chocolate\nMargarita\nBrown Sugar\nSalted Chocolate Caramel\nHibiscus Passion Fruit\nBlueberry\nCoconut Caramel (Samoa Cookie)\nCotton Candy"
    },

    { "type": "header", "content": "Modifiers" },
    { "type": "text", "id": "ice_levels", "label": "Ice levels (comma separated)", "default": "No Ice, Light Ice, Regular Ice, Extra Ice" },
    { "type": "textarea", "id": "boosters", "label": "Boosters (one per line)", "default": "Kratom Shot\nKava Shot\nEnergy Shot" },
    { "type": "textarea", "id": "sweeteners", "label": "Sweeteners (one per line)", "default": "Stevia\nCane Sugar\nAgave" },
    { "type": "textarea", "id": "creamers", "label": "Creamers (one per line)", "default": "Half & Half\nAlmond Milk\nOat Milk\nCoconut Milk" },

    { "type": "header", "content": "Delta-9 (THC) concentration options" },
    { "type": "text", "id": "thc_concentrations", "label": "THC concentrations (comma separated)", "default": "2 mg, 5 mg, 10 mg" },

    { "type": "header", "content": "Copy & UX" },
    { "type": "text", "id": "staff_msg", "label": "Staff message for Kratom/Kava Gallon", "default": "Discuss flavor preferences with staff." }
  ],
  "blocks": [
    {
      "type": "booster",
      "name": "Booster",
      "settings": [{ "type": "text", "id": "label", "label": "Booster label", "default": "Kratom Booster" }]
    }
  ],
  "presets": [{ "name": "Enhanced Drink Builder" }]
}
{% endschema %}
