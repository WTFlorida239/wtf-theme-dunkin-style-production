{% comment %}
  Enhanced Drink Builder – WTF | Welcome To Florida
  - Size: Medium, Large, Gallon
  - Live price preview
  - Strains: Green / Red / White / Yellow (max 2; supports ½+½)
  - Flavors w/ pump counters + category (Regular / Sugar-Free)
  - Gallon logic + THC selector when applicable
  - Saves all choices as line item properties
{% endcomment %}

<section
  id="enhanced-drink-builder"
  class="wtf-builder"
  aria-labelledby="builder-title"
  data-product-id="{{ product.id }}"
>
  <h2 id="builder-title">{{ section.settings.title | default: 'Build your drink' }}</h2>

  {%- assign included_pumps = product.metafields.custom.included_pumps | default: 4 -%}
  {%- assign extra_pump_price = product.metafields.custom.extra_pump_price | default: 0.50 -%}
  {%- assign max_flavors = product.metafields.custom.max_flavors | default: 3 -%}

  <form
    id="builder-form-{{ product.id }}"
    method="post"
    action="/cart/add"
    data-product-form
    role="form"
    aria-describedby="builder-help"
  >
    <input type="hidden" name="id" id="builder-variant-id">

    <!-- Live price -->
    <div class="price-row" aria-live="polite">
      <span class="current-price" id="builder-price">{{ product.price | money }}</span>
      <span class="upsell-hint" id="builder-upsell"></span>
    </div>

    <!-- Size (variants) -->
    <fieldset class="wtf-db__group" style="margin-bottom:1rem;">
      <legend class="wtf-db__legend">Size</legend>
      <div class="wtf-db__chips chip-row" role="radiogroup" aria-label="Choose size">
        {%- for v in product.variants -%}
          {%- assign chip_id = 'size-' | append: section.id | append: '-' | append: forloop.index -%}
          <label class="chip" for="{{ chip_id }}" style="display:inline-block;margin:.25rem .5rem .25rem 0;">
            <input
              type="radio"
              id="{{ chip_id }}"
              name="size"
              value="{{ v.title | escape }}"
              data-variant-id="{{ v.id }}"
              data-price="{{ v.price | divided_by: 100.0 }}"
              {% if forloop.first %}checked{% endif %}
            />
            <span>{{ v.title }}</span>
          </label>
        {%- endfor -%}
      </div>
      <input type="hidden" name="properties[Size]" id="prop-size" value="">
    </fieldset>

    <!-- Strains (max 2; ½+½ supported) -->
    <fieldset>
      <legend>Strain (up to 2)</legend>
      <div class="chip-row" aria-label="Choose up to two strains">
        {% assign strains = 'Green,Red,White,Yellow' | split: ',' %}
        {% for s in strains %}
          <label class="chip">
            <input type="checkbox" name="strain" value="{{ s }}">
            {{ s }}
          </label>
        {% endfor %}
      </div>
      <input type="hidden" name="properties[Strain]" id="prop-strain" value="">
    </fieldset>

    <!-- THC concentration (only when product has thc variant metafield & Gallon is selected) -->
    {% if product.metafields.custom.thc_variant_id %}
      <fieldset id="thc-fieldset" hidden>
        <legend>THC concentration</legend>
        <div class="chip-row" role="radiogroup" aria-label="THC concentration">
          <label class="chip"><input type="radio" name="thc" value="Low">Low</label>
          <label class="chip"><input type="radio" name="thc" value="Medium">Medium</label>
          <label class="chip"><input type="radio" name="thc" value="High">High</label>
        </div>
        <input type="hidden" name="properties[THC Concentration]" id="prop-thc" value="">
      </fieldset>
    {% endif %}

    <!-- Flavors (category + pumps) -->
    <fieldset>
      <legend>Flavors</legend>

      {% comment %} If you have a snippet with your exact lists, render it. {% endcomment %}
      {% render 'wtf-flavor-options' %}
      {% comment %} If that snippet is missing, the JS will still allow manual entry via the search + chips UI you can add later. {% endcomment %}

      <div
        class="pump-meta small-text"
        id="pump-meta"
        data-included="{{ included_pumps }}"
        data-extra="{{ extra_pump_price }}"
        data-maxflavors="{{ max_flavors }}"
      >
        Included pumps: <strong>{{ included_pumps }}</strong>. Extra pump:
        <strong>{{ extra_pump_price | money }}</strong>.
      </div>
      <input type="hidden" name="properties[Flavors]" id="prop-flavors" value="">
      <input type="hidden" name="properties[Flavor Category]" id="prop-flavor-category" value="">
      <input type="hidden" name="properties[Flavor Pump Detail]" id="prop-pumps" value="">
    </fieldset>

    <!-- Boosters / Sweeteners / Creamers -->
    {% if section.settings.show_boosters %}
      <fieldset>
        <legend>Boosters</legend>
        <div class="chip-row">
          {% for b in section.blocks | where: 'type', 'booster' %}
            <label class="chip"
              ><input type="checkbox" name="booster" value="{{ b.settings.label | escape }}">{{ b.settings.label -}}
            </label>
          {% endfor %}
        </div>
        <input type="hidden" name="properties[Boosters]" id="prop-boosters" value="">
      </fieldset>
    {% endif %}

    <fieldset>
      <legend>Sweeteners</legend>
      <div class="chip-row">
        <label class="chip"><input type="checkbox" name="sweetener" value="Simple Syrup">Simple Syrup</label>
        <label class="chip"><input type="checkbox" name="sweetener" value="Stevia">Stevia</label>
        <label class="chip"
          ><input type="checkbox" name="sweetener" value="Sugar-Free Vanilla">Sugar-Free Vanilla</label
        >
      </div>
      <input type="hidden" name="properties[Sweeteners]" id="prop-sweeteners" value="">
    </fieldset>

    <fieldset>
      <legend>Creamers</legend>
      <div class="chip-row">
        <label class="chip"><input type="checkbox" name="creamer" value="Half & Half">Half &amp; Half</label>
        <label class="chip"><input type="checkbox" name="creamer" value="Oat Milk">Oat Milk</label>
        <label class="chip"><input type="checkbox" name="creamer" value="Almond Milk">Almond Milk</label>
      </div>
      <input type="hidden" name="properties[Creamers]" id="prop-creamers" value="">
    </fieldset>

    <!-- Gallon message -->
    <p id="gallon-note" class="small-text" hidden>
      For Gallons of Kratom or Kava, flavors are discussed with staff at pickup.
    </p>

    <!-- Error Display -->
    <div data-product-form-error class="form-error" hidden>
      <p class="error-message" role="alert"></p>
    </div>

    <!-- Submit -->
    <button type="submit" class="btn btn-primary" id="builder-add">Add to cart</button>

    <!-- Helper -->
    <p id="builder-help" class="visually-hidden">
      Use the chips to choose options. You can select up to two strains and a limited number of flavor pumps per size.
    </p>
  </form>

  <!-- Pass variant data to JS -->
  <script type="application/json" id="builder-variants-{{ product.id }}">
    {{ product.variants | json }}
  </script>
  {% comment %}
    Note: The product form above includes data-product-form which our global.js
    uses to intercept and perform an AJAX add-to-cart. This ensures the cart
    drawer opens without a page reload when enabled.
  {% endcomment %}
</section>

{% schema %}
{
  "name": "Enhanced Drink Builder",
  "templates": ["product", "page"],
  "settings": [
    { "type": "text", "id": "title", "label": "Heading", "default": "Build your drink" },
    { "type": "checkbox", "id": "show_boosters", "label": "Show boosters", "default": true },
    { "type": "product", "id": "product", "label": "Product (for Pages)" },

    { "type": "select", "id": "product_kind", "label": "Product kind (for Gallon logic)", "default": "auto",
      "options": [
        { "value": "auto", "label": "Auto-detect from product tags" },
        { "value": "kratom", "label": "Kratom" },
        { "value": "kava", "label": "Kava" },
        { "value": "delta9", "label": "Delta-9" }
      ]
    },

    { "type": "header", "content": "Flavor lists" },
    { "type": "textarea", "id": "sugar_free_flavors", "label": "Sugar-free flavors (one per line)",
      "default": "Blackberry\nWhite Chocolate\nPumpkin Spice\nLemon Spritz\nVanilla\nMaple Bourbon Pecan\nPeach\nSimple Syrup\nCosmopolitain\nRaspberry Lemonade\nPomegranate\nBlueberry Lavender\nSalted Caramel\nRose\nMexican Chocolate"
    },
    { "type": "textarea", "id": "regular_flavors", "label": "Regular-sugar flavors (one per line)",
      "default": "Caramel Apple Butter\nLime\nGrenadine\nDark Chocolate\nMargarita\nBrown Sugar\nSalted Chocolate Caramel\nHibiscus Passion Fruit\nBlueberry\nCoconut Caramel (Samoa Cookie)\nCotton Candy"
    },

    { "type": "header", "content": "Modifiers" },
    { "type": "text", "id": "ice_levels", "label": "Ice levels (comma separated)", "default": "No Ice, Light Ice, Regular Ice, Extra Ice" },
    { "type": "textarea", "id": "boosters", "label": "Boosters (one per line)", "default": "Kratom Shot\nKava Shot\nEnergy Shot" },
    { "type": "textarea", "id": "sweeteners", "label": "Sweeteners (one per line)", "default": "Stevia\nCane Sugar\nAgave" },
    { "type": "textarea", "id": "creamers", "label": "Creamers (one per line)", "default": "Half & Half\nAlmond Milk\nOat Milk\nCoconut Milk" },

    { "type": "header", "content": "Delta-9 (THC) concentration options" },
    { "type": "text", "id": "thc_concentrations", "label": "THC concentrations (comma separated)", "default": "2 mg, 5 mg, 10 mg" },

    { "type": "header", "content": "Copy & UX" },
    { "type": "text", "id": "staff_msg", "label": "Staff message for Kratom/Kava Gallon", "default": "Discuss flavor preferences with staff." }
  ],
  "blocks": [
    {
      "type": "booster",
      "name": "Booster",
      "settings": [{ "type": "text", "id": "label", "label": "Booster label", "default": "Kratom Booster" }]
    }
  ],
  "presets": [{ "name": "Enhanced Drink Builder" }]
}
{% endschema %}
