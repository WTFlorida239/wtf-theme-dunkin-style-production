{%- comment -%}
  Centralized drink data from metafields so JS can stay dumb.
  Reads:
  - product.metafields.custom.pump_limits (JSON like {"medium":4,"large":6,"gallon":12})
  - product.metafields.custom.available_flavors (string CSV or JSON)
  - product.metafields.custom.pump_cost (money)
  - shop.metafields.custom.business_hours / contact / location (for hours snippet)
{%- endcomment -%}

{%- assign pump_limits_json = product.metafields.custom.pump_limits | default: '{}' -%}
{%- assign pump_cost = product.metafields.custom.pump_cost | default: 0 -%}

{%- assign flavors_raw = product.metafields.custom.available_flavors | default: '' -%}
{%- if flavors_raw contains '[' and flavors_raw contains ']' -%}
  {%- assign flavors_list = flavors_raw | parse_json -%}
{%- else -%}
  {%- assign flavors_list = flavors_raw | split: ',' | map: 'strip' -%}
{%- endif -%}

{%- comment -%}
  Temporary sizeâ†’variant fallback map until metafield is created:
  product.metafields.custom.variant_map (JSON):
    {"medium": 1234567890, "large": 1234567891, "gallon": 1234567892}
{%- endcomment -%}
{%- assign variant_map_json = product.metafields.custom.variant_map | default: '{}' -%}

<script id="wtf-drink-data" type="application/json">
{
  "productId": {{ product.id | json }},
  "handle": {{ product.handle | json }},
  "title": {{ product.title | json }},
  "variants": [
    {%- for v in product.variants -%}
      {"id": {{ v.id }}, "title": {{ v.title | json }}, "price": {{ v.price | money_without_currency | replace: ',', '' | json }}, "available": {{ v.available | json }} }{% unless forloop.last %},{% endunless %}
    {%- endfor -%}
  ],
  "options": {{ product.options_with_values | json }},
  "pumpLimits": {{ pump_limits_json }},
  "pumpCost": {{ pump_cost | json }},
  "availableFlavors": {{ flavors_list | json }},
  "variantMap": {{ variant_map_json }},
  "shopMeta": {
    "hours": {{ shop.metafields.custom.business_hours | default: '{}' }},
    "contact": {{ shop.metafields.custom.contact_info | default: '{}' }},
    "location": {{ shop.metafields.custom.location | json | default: '""' }}
  }
}
</script>
