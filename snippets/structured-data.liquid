{% comment %}
  Additional structured data that complements enhanced-meta-tags.liquid.
  Focused on contextual schemas (breadcrumbs, articles, collections, FAQ).
{% endcomment %}

{%- liquid
  assign breadcrumb_collection = collection
  if breadcrumb_collection == blank and product and product.collections_count > 0
    assign breadcrumb_collection = product.collections.first
  endif
  assign is_page_template = template contains 'page'
  assign is_article_template = template contains 'article'
  assign is_collection_template = template contains 'collection'
  assign is_product_template = template contains 'product'
-%}

{%- capture breadcrumb_items -%}
  {
    "@type": "ListItem",
    "position": 1,
    "name": {{ 'Home' | json }},
    "item": {{ shop.url | json }}
  }
  {%- if is_collection_template and collection -%}
    ,{
      "@type": "ListItem",
      "position": 2,
      "name": {{ collection.title | json }},
      "item": {{ collection.url | prepend: shop.url | json }}
    }
  {%- elsif is_product_template and product -%}
    {%- if breadcrumb_collection -%}
      ,{
        "@type": "ListItem",
        "position": 2,
        "name": {{ breadcrumb_collection.title | json }},
        "item": {{ breadcrumb_collection.url | prepend: shop.url | json }}
      },{
        "@type": "ListItem",
        "position": 3,
        "name": {{ product.title | json }},
        "item": {{ product.url | prepend: shop.url | json }}
      }
    {%- else -%}
      ,{
        "@type": "ListItem",
        "position": 2,
        "name": {{ product.title | json }},
        "item": {{ product.url | prepend: shop.url | json }}
      }
    {%- endif -%}
  {%- elsif is_article_template and article -%}
    ,{
      "@type": "ListItem",
      "position": 2,
      "name": {{ blog.title | json }},
      "item": {{ blog.url | prepend: shop.url | json }}
    },{
      "@type": "ListItem",
      "position": 3,
      "name": {{ article.title | json }},
      "item": {{ article.url | prepend: shop.url | json }}
    }
  {%- elsif is_page_template and page and page.url != '/' -%}
    ,{
      "@type": "ListItem",
      "position": 2,
      "name": {{ page.title | json }},
      "item": {{ page.url | prepend: shop.url | json }}
    }
  {%- endif -%}
{%- endcapture -%}

{%- if breadcrumb_items contains '"position": 2' -%}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {{ breadcrumb_items | strip_newlines }}
  ]
}
</script>
{%- endif -%}

{%- if is_collection_template and collection and collection.all_products_count > 0 -%}
  {%- assign min_price = '' -%}
  {%- assign max_price = '' -%}
  {%- assign offer_count = 0 -%}
  {%- for prod in collection.products -%}
    {%- for variant in prod.variants -%}
      {%- assign offer_count = offer_count | plus: 1 -%}
      {%- if min_price == '' or variant.price < min_price -%}
        {%- assign min_price = variant.price -%}
      {%- endif -%}
      {%- if max_price == '' or variant.price > max_price -%}
        {%- assign max_price = variant.price -%}
      {%- endif -%}
    {%- endfor -%}
  {%- endfor -%}
  {%- capture collection_products -%}
    {%- for prod in collection.products limit: 12 -%}
      {
        "@type": "Product",
        "@id": {{ prod.url | prepend: shop.url | append: '#product' | json }},
        "name": {{ prod.title | json }},
        "url": {{ prod.url | prepend: shop.url | json }}
      }{% unless forloop.last %},{% endunless %}
    {%- endfor -%}
  {%- endcapture -%}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "CollectionPage",
  "name": {{ collection.title | json }},
  "description": {{ collection.description | strip_html | truncate: 320 | json }},
  "mainEntity": {
    "@type": "ItemList",
    "numberOfItems": {{ collection.all_products_count | default: collection.products_count }},
    "itemListElement": [
      {{ collection_products | strip_newlines }}
    ]
  },
  "offers": {
    "@type": "AggregateOffer",
    "priceCurrency": {{ shop.currency | json }},
    "offerCount": {{ offer_count | default: collection.all_products_count | at_least: 1 }},
    {%- if min_price != '' -%}
    "lowPrice": {{ min_price | money_without_currency | replace: ',', '' | json }},{%- endif -%}
    {%- if max_price != '' -%}
    "highPrice": {{ max_price | money_without_currency | replace: ',', '' | json }},{%- endif -%}
    "availability": {{ 'https://schema.org/InStock' | json }}
  },
  "url": {{ collection.url | prepend: shop.url | json }},
  {%- if collection.image -%}
  "image": {{ collection.image | image_url: width: 1200 | prepend: 'https:' | json }},{%- endif -%}
  "isPartOf": {{ shop.url | append: '#website' | json }}
}
</script>
{%- endif -%}

{%- if is_article_template and article -%}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "mainEntityOfPage": {{ article.url | prepend: shop.url | json }},
  "headline": {{ article.title | json }},
  "description": {{ article.excerpt_or_content | strip_html | truncate: 320 | json }},
  {%- if article.image -%}
  "image": {{ article.image | image_url: width: 1200 | prepend: 'https:' | json }},{%- endif -%}
  "datePublished": {{ article.published_at | date: '%Y-%m-%dT%H:%M:%S%:z' | json }},
  "dateModified": {{ article.updated_at | date: '%Y-%m-%dT%H:%M:%S%:z' | json }},
  "author": {
    "@type": "Person",
    "name": {{ article.author | json }}
  },
  "publisher": {
    "@type": "Organization",
    "name": {{ shop.name | json }},
    {%- if shop.brand.logo -%}
    "logo": {
      "@type": "ImageObject",
      "url": {{ shop.brand.logo | image_url: width: 600 | prepend: 'https:' | json }}
    }
    {%- endif -%}
  },
  "keywords": {{ article.tags | join: ', ' | json }}
}
</script>
{%- endif -%}

{%- liquid
  assign faq_source = blank
  if page and page.metafields.custom.faq_json != blank
    assign faq_source = page.metafields.custom.faq_json.value
  elsif product and product.metafields.custom.faq_json != blank
    assign faq_source = product.metafields.custom.faq_json.value
  endif
-%}
{%- assign faq_output = '' -%}
{%- if faq_source and faq_source.size > 0 -%}
  {%- capture faq_output -%}
    {%- for entry in faq_source -%}
      {
        "@type": "Question",
        "name": {{ entry.question | default: entry.title | json }},
        "acceptedAnswer": {
          "@type": "Answer",
          "text": {{ entry.answer | default: entry.body | json }}
        }
      }{% unless forloop.last %},{% endunless %}
    {%- endfor -%}
  {%- endcapture -%}
{%- elsif page and (page.handle contains 'faq' or page.title contains 'FAQ') -%}
  {%- capture faq_output -%}
    {
      "@type": "Question",
      "name": "What is kava and how does it make you feel?",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "Kava is a traditional Pacific Island beverage made from the root of the kava plant. Guests describe the feeling as relaxed focus with gentle euphoria."
      }
    },{
      "@type": "Question",
      "name": "Is kava legal in Florida?",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "Yes. Kava and kratom are both legal in Florida, and WTF follows all local and federal regulations for botanical beverages."
      }
    },{
      "@type": "Question",
      "name": "Do you offer alcohol-free options for sober curious people?",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "All drinks at WTF are alcohol-free. Our menu focuses on kava, kratom, Delta-9 compliant beverages, and wellness-focused mocktails."
      }
    }
  {%- endcapture -%}
{%- endif -%}

{%- if faq_output != '' -%}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "FAQPage",
  "mainEntity": [
    {{ faq_output | strip_newlines }}
  ]
}
</script>
{%- endif -%}
