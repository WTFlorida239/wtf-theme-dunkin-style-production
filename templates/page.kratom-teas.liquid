{%- comment -%}
  Kratom Teas — Size = variant; Flavor = line item properties
  Adds grouped flavors (Sugar-Free vs Regular) and saves "Flavor Category".
  "Gallon" size hides flavor chips and shows a staff note.

  Config:
    - Set page metafield: namespace `wtf`, key `product_handle` → product handle to sell here.
      If not set, defaults to 'custom-kratom-tea'.

  Requirements:
    - assets/wtf-variants.js (maps Size chips → hidden variant id)
    - assets/wtf-ajax-cart.js (AJAX add-to-cart for [data-wtf-ajax] forms)
    - layout/theme.liquid includes the cart count hydrator and these assets once.
{%- endcomment -%}

{%- comment -%} Styled flavor list (homepage card style) {%- endcomment -%}
{% render 'wtf-drink-data' %}
{% render 'wtf-collection-cards',
  title: 'Kratom Teas',
  subtitle: 'Green, Red, White & Yellow strains with premium flavorings',
  items: WTF_KRATOM_ITEMS,
  color: 'kratom',
  back_url: routes.root_url
%}

{%- assign kratom_handle = page.metafields.wtf.product_handle | default: 'custom-kratom-tea' -%}
{%- assign product = all_products[kratom_handle] -%}

{%- if product == null -%}
  <main id="MainContent" class="page-width" style="max-width:1100px;margin:0 auto;padding:16px;">
    <h1>Kratom Teas</h1>
    <p>
      Product "<strong>{{ kratom_handle }}</strong>" not found. Set the page metafield
      <code>wtf.product_handle</code> to a valid product handle and reload.
    </p>
  </main>
{%- else -%}
  <main id="MainContent" class="page-width" style="max-width:1100px;margin:0 auto;padding:16px;">
    <header style="display:flex;align-items:center;gap:16px;margin-bottom:16px;">
      <img
        src="{{ 'kratom_teas_150x150.png' | asset_url }}"
        alt="Kratom Teas"
        width="75"
        height="75"
        loading="eager"
        decoding="async"
        style="border-radius:12px;box-shadow:0 3px 10px rgba(0,0,0,.08);"
      >
      <div>
        <h1 style="margin:0;font-weight:800;letter-spacing:.2px;">Kratom Teas</h1>
        <div style="color:#666;">Choose a Size, pick a Flavor, add to cart.</div>
      </div>
    </header>

    <form
      action="/cart/add"
      method="post"
      enctype="multipart/form-data"
      data-wtf-ajax
      style="display:block;background:#fff;border:1px solid #eee;border-radius:16px;padding:16px 16px 20px;box-shadow:0 6px 24px rgba(0,0,0,.06);"
    >
      {%- comment -%} Expose product JSON so wtf-variants.js doesn’t need to fetch {%- endcomment -%}
      <script>
        window.WTF_PRODUCT_JSON={{ product | json }};
      </script>

      {%- comment -%} Size (variant option) — mapped by wtf-variants.js to hidden id {%- endcomment -%}
      {%- assign size_option = '' -%}
      {%- for opt in product.options_with_values -%}
        {%- if opt.name == 'Size' or opt.name == 'size' -%}{%- assign size_option = opt -%}{%- endif -%}
      {%- endfor -%}

      <section style="margin-bottom:14px;">
        <label style="display:block;font-weight:700;margin-bottom:8px;">Size</label>
        <div style="display:flex;flex-wrap:wrap;gap:8px;">
          {%- if size_option != blank -%}
            {%- for val in size_option.values -%}
              <button
                type="button"
                class="wtf-chip wtf-chip--size{% if forloop.first %} wtf-chip--active{% endif %}"
                data-option="{{ size_option.name }}"
                data-value="{{ val }}"
                aria-label="Size {{ val }}"
                aria-checked="{% if forloop.first %}true{% else %}false{% endif %}"
                role="radio"
              >
                {{ val }}
              </button>
            {%- endfor -%}
          {%- else -%}
            <em>No Size option found on this product. Add a <strong>Size</strong> option to variants.</em>
          {%- endif -%}
        </div>
      </section>

      {%- comment -%}
        Flavor (Line Item Properties)
        - Renders Sugar-Free and Regular groups (normalized names).
        - Saves properties[Flavor] and properties[Flavor Category].
      {%- endcomment -%}
      {%- assign sugar_free = '
      Blackberry,
      White Chocolate,
      Pumpkin Spice,
      Lemon Spritz,
      Vanilla,
      Maple Bourbon Pecan,
      Peach,
      Simple Syrup,
      Cosmopolitan,
      Raspberry Lemonade,
      Pomegranate,
      Blueberry Lavender,
      Salted Caramel,
      Rose,
      Mexican Chocolate
      '
        | strip
        | newline_to_br
        | replace: '<br />', ','
        | split: ','
        | map: 'strip'
      -%}

      {%- assign regular = '
      Caramel Apple Butter,
      Lime,
      Grenadine,
      Dark Chocolate,
      Margarita,
      Brown Sugar,
      Salted Chocolate Caramel,
      Hibiscus Passion Fruit,
      Blueberry,
      Coconut Caramel (Samoa Cookie),
      Cotton Candy
      '
        | strip
        | newline_to_br
        | replace: '<br />', ','
        | split: ','
        | map: 'strip'
      -%}

      <section style="margin-bottom:14px;">
        <label style="display:block;font-weight:700;margin-bottom:8px;">Flavor</label>

        <!-- Hidden inputs saved to the cart -->
        <input type="hidden" name="properties[Flavor]" id="kratomFlavor">
        <input type="hidden" name="properties[Flavor Category]" id="kratomFlavorCategory">

        <div id="kratom-flavor-wrapper">
          <div style="font-weight:600;margin:.5rem 0 .25rem;">Sugar-Free Syrups</div>
          <div class="kratom-chip-row" style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:10px;">
            {%- for f in sugar_free -%}
              <button
                type="button"
                class="wtf-chip wtf-chip--flavor"
                data-flavor="{{ f | escape }}"
                data-group="Sugar Free"
              >
                {{ f }}
              </button>
            {%- endfor -%}
          </div>

          <div style="font-weight:600;margin:.5rem 0 .25rem;">Regular Sugar Syrups</div>
          <div class="kratom-chip-row" style="display:flex;flex-wrap:wrap;gap:8px;">
            {%- for f in regular -%}
              <button
                type="button"
                class="wtf-chip wtf-chip--flavor"
                data-flavor="{{ f | escape }}"
                data-group="Regular"
              >
                {{ f }}
              </button>
            {%- endfor -%}
          </div>
        </div>

        <div
          id="kratom-gallon-note"
          style="display:none;margin:.5rem 0;font-size:.9rem;background:#fff3cd;border:1px solid #ffeaa7;border-radius:8px;padding:10px;"
        >
          For <strong>Gallon</strong> Kratom teas, please discuss flavor preferences with staff.
        </div>
      </section>

      {%- comment -%} Quantity {%- endcomment -%}
      <section style="margin-bottom:14px;">
        <label style="display:block;font-weight:700;margin-bottom:8px;">Quantity</label>
        <div style="display:flex;align-items:center;gap:10px;">
          <button
            type="button"
            class="wtf-chip"
            onclick="(function(i){i.value=Math.max(1,parseInt(i.value||'1',10)-1)})(document.getElementById('kratomQty'))"
          >
            −
          </button>
          <input
            id="kratomQty"
            type="number"
            name="quantity"
            value="1"
            min="1"
            style="width:90px;text-align:center;padding:10px;border:1px solid #ddd;border-radius:999px;"
          >
          <button
            type="button"
            class="wtf-chip"
            onclick="(function(i){i.value=Math.max(1,parseInt(i.value||'1',10)+1)})(document.getElementById('kratomQty'))"
          >
            +
          </button>
        </div>
      </section>

      {%- comment -%} Variant target + submit {%- endcomment -%}
      <input type="hidden" name="id" id="kratomVariantId" value="">
      <button type="submit" class="wtf-add-to-cart-btn" style="margin-top:6px;">
        Add to Cart — <span id="kratom-price">{{ product.selected_or_first_available_variant.price | money }}</span>
      </button>
    </form>
  </main>

  {%- comment -%} Helpers: flavor selection, Gallon rule, price updates {%- endcomment -%}
  <script>
    (function () {
      // ----- Flavor chips → properties[Flavor] + properties[Flavor Category]
      var wrap = document.getElementById('kratom-flavor-wrapper');
      var flavorInput = document.getElementById('kratomFlavor');
      var catInput = document.getElementById('kratomFlavorCategory');

      function setFlavor(btn) {
        if (!btn || !flavorInput || !catInput) return;
        flavorInput.value = btn.getAttribute('data-flavor') || '';
        catInput.value = btn.getAttribute('data-group') || '';
        wrap.querySelectorAll('.wtf-chip--flavor').forEach(function (b) {
          var active = b === btn;
          b.classList.toggle('wtf-chip--active', active);
          b.setAttribute('aria-checked', active ? 'true' : 'false');
        });
        document.dispatchEvent(
          new CustomEvent('wtf:flavor:selected', {
            detail: { flavor: flavorInput.value, category: catInput.value },
          })
        );
      }

      if (wrap) {
        var first = wrap.querySelector('.wtf-chip--flavor');
        if (first) setFlavor(first);
        wrap.addEventListener('click', function (e) {
          var btn = e.target.closest('.wtf-chip--flavor');
          if (btn) setFlavor(btn);
        });
      }

      // ----- Gallon rule (hide flavors + show note)
      var sizeButtons = document.querySelectorAll('.wtf-chip--size');
      var note = document.getElementById('kratom-gallon-note');
      function applyGallonRule(sizeLabel) {
        var isGallon = (sizeLabel || '').toLowerCase() === 'gallon';
        if (wrap) wrap.style.display = isGallon ? 'none' : '';
        if (note) note.style.display = isGallon ? '' : 'none';
        if (isGallon && flavorInput && catInput) {
          flavorInput.value = '';
          catInput.value = '';
          wrap &&
            wrap.querySelectorAll('.wtf-chip--flavor').forEach(function (b) {
              b.classList.remove('wtf-chip--active');
              b.setAttribute('aria-checked', 'false');
            });
        }
      }
      sizeButtons.forEach(function (btn) {
        btn.addEventListener('click', function () {
          applyGallonRule((btn.textContent || '').trim());
        });
      });
      var selectedSize = document.querySelector('.wtf-chip--size.wtf-chip--active');
      applyGallonRule(selectedSize ? selectedSize.textContent.trim() : '');

      // ----- Update price on variant change (from wtf-variants.js)
      document.addEventListener('wtf:variant:change', function (e) {
        var v = e.detail && e.detail.variant;
        if (!v) return;
        var money = (v.price / 100).toLocaleString(undefined, { style: 'currency', currency: 'USD' });
        var priceEl = document.getElementById('kratom-price');
        if (priceEl) priceEl.textContent = money;
      });
    })();
  </script>

  <style>
    .wtf-chip--flavor.wtf-chip--active {
      outline: 2px solid var(--color-accent, #ff6a00);
    }
  </style>
{%- endif -%}
