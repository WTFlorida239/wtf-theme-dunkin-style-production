{%- comment -%}
  This template combines a custom UI with a standard Shopify product form.
  The variant ID for the "Custom Kratom Tea" product should be set in the theme settings for best results.
  Fallback is the first available variant of the assigned product.
{%- endcomment -%}
{%- assign kratom_variant_id = settings.kratom_tea_variant_id
  | default: product.selected_or_first_available_variant.id
-%}

<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    line-height: 1.6;
    color: #333;
    background: #f8f9fa;
  }

  /* Header Navigation */
  .wtf-header {
    background: linear-gradient(135deg, #ff6600 0%, #ff8533 100%);
    padding: 15px 0;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    position: sticky;
    top: 0;
    z-index: 1000;
  }
  .wtf-nav-container {
    max-width: 1200px;
    margin: 0 auto;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 20px;
  }
  .wtf-logo-section {
    display: flex;
    align-items: center;
    gap: 15px;
  }
  .wtf-logo-circle {
    background: white;
    border-radius: 50%;
    width: 60px;
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    overflow: hidden;
  }
  .wtf-logo-circle img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 50%;
  }
  .wtf-logo-text h1 {
    color: white;
    margin: 0;
    font-size: 28px;
    font-weight: bold;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
  }
  .wtf-logo-text p {
    color: white;
    margin: 0;
    font-size: 14px;
    opacity: 0.9;
  }
  .wtf-main-nav {
    display: flex;
    gap: 30px;
    align-items: center;
  }
  .wtf-nav-link {
    color: white;
    text-decoration: none;
    font-weight: 600;
    font-size: 16px;
    padding: 8px 16px;
    border-radius: 25px;
    transition: all 0.3s ease;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
  }
  .wtf-nav-link:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: translateY(-2px);
  }
  .wtf-cart-btn {
    background: white;
    color: #ff6600;
    text-decoration: none;
    font-weight: bold;
    font-size: 16px;
    padding: 10px 20px;
    border-radius: 25px;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
  }
  .wtf-cart-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  }

  /* Product Page */
  .wtf-product-page {
    max-width: 1200px;
    margin: 0 auto;
    padding: 40px 20px;
  }

  .wtf-back-button {
    display: inline-block;
    color: #ff6600;
    text-decoration: none;
    font-weight: 600;
    margin-bottom: 30px;
    padding: 10px 20px;
    border: 2px solid #ff6600;
    border-radius: 25px;
    transition: all 0.3s ease;
  }

  .wtf-back-button:hover {
    background: #ff6600;
    color: white;
    transform: translateY(-2px);
  }

  .wtf-product-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 60px;
    align-items: start;
  }

  .wtf-product-images {
    position: sticky;
    top: 120px;
  }

  .wtf-main-image {
    width: 100%;
    height: 500px;
    border-radius: 20px;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    margin-bottom: 20px;
  }

  .wtf-main-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .wtf-product-info {
    background: white;
    padding: 40px;
    border-radius: 20px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
  }

  .wtf-product-title {
    font-size: 36px;
    font-weight: bold;
    color: #333;
    margin-bottom: 15px;
  }

  .wtf-product-price {
    font-size: 28px;
    font-weight: bold;
    color: #ff6600;
    margin-bottom: 25px;
  }

  .wtf-product-description {
    font-size: 16px;
    color: #666;
    line-height: 1.6;
    margin-bottom: 30px;
  }

  /* Dunkin-Style Selection Sections */
  .wtf-selection-section {
    margin-bottom: 35px;
    padding: 25px;
    background: #f8f9fa;
    border-radius: 15px;
    border: 2px solid #e9ecef;
  }

  .wtf-selection-title {
    font-size: 20px;
    font-weight: bold;
    color: #333;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .wtf-selection-title::before {
    content: '‚òï';
    font-size: 24px;
  }

  .wtf-selection-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 12px;
  }

  .wtf-selection-option {
    position: relative;
  }

  .wtf-selection-option input[type='radio'] {
    position: absolute;
    opacity: 0;
    width: 0;
    height: 0;
  }

  .wtf-selection-option label {
    display: block;
    padding: 15px 20px;
    background: white;
    border: 3px solid #e9ecef;
    border-radius: 12px;
    text-align: center;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
  }

  .wtf-selection-option input[type='radio']:checked + label {
    background: #ff6600;
    color: white;
    border-color: #ff6600;
    transform: translateY(-3px);
    box-shadow: 0 6px 20px rgba(255, 102, 0, 0.3);
  }

  .wtf-selection-option label:hover {
    border-color: #ff6600;
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
  }

  /* Strain Mix Section */
  .wtf-strain-mix {
    display: none;
    margin-top: 20px;
    padding: 20px;
    background: white;
    border-radius: 12px;
    border: 2px solid #ff6600;
  }

  .wtf-strain-mix.active {
    display: block;
  }

  .wtf-strain-mix h4 {
    color: #ff6600;
    margin-bottom: 15px;
    font-size: 18px;
  }

  .wtf-strain-row {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 15px;
  }

  .wtf-strain-select {
    flex: 1;
    padding: 12px;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 600;
  }

  /* Flavor Grid */
  .wtf-flavor-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 10px;
    max-height: 300px;
    overflow-y: auto;
    padding: 10px;
    background: white;
    border-radius: 12px;
    border: 2px solid #e9ecef;
  }

  .wtf-flavor-option {
    position: relative;
  }

  .wtf-flavor-option input[type='checkbox'] {
    position: absolute;
    opacity: 0;
    width: 0;
    height: 0;
  }

  .wtf-flavor-option label {
    display: block;
    padding: 10px 12px;
    background: #f8f9fa;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    text-align: center;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .wtf-flavor-option input[type='checkbox']:checked + label {
    background: #28a745;
    color: white;
    border-color: #28a745;
    transform: scale(1.05);
  }

  .wtf-flavor-option label:hover {
    border-color: #28a745;
    transform: scale(1.02);
  }

  /* Pump System Styles */
  .wtf-pump-info {
    background: #e8f4fd;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
    border-left: 4px solid #007bff;
  }

  .wtf-pump-info p {
    margin: 5px 0;
    font-size: 14px;
    color: #495057;
  }

  .wtf-pump-display {
    margin-top: 20px;
    padding: 15px;
    background: #fff3cd;
    border-radius: 8px;
    border-left: 4px solid #ffc107;
    display: none;
  }

  .wtf-pump-display.active {
    display: block;
  }

  .wtf-pump-display h4 {
    color: #856404;
    margin-bottom: 10px;
    font-size: 16px;
  }

  #pump-breakdown {
    font-size: 14px;
    color: #495057;
  }

  .wtf-extra-cost {
    font-size: 18px;
    font-weight: bold;
    color: #ff6600;
    margin-left: 15px;
  }

  /* Comments Box */
  .wtf-comments-box {
    width: 100%;
    min-height: 100px;
    padding: 15px;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    font-size: 14px;
    font-family: inherit;
    resize: vertical;
    transition: border-color 0.3s ease;
  }

  .wtf-comments-box:focus {
    outline: none;
    border-color: #ff6600;
  }

  /* Quantity and Add to Cart */
  .wtf-quantity-section {
    margin-bottom: 30px;
  }

  .wtf-quantity-controls {
    display: flex;
    align-items: center;
    gap: 15px;
  }

  .wtf-quantity-input {
    display: flex;
    align-items: center;
    border: 3px solid #e9ecef;
    border-radius: 12px;
    overflow: hidden;
  }

  .wtf-quantity-btn {
    background: #f8f9fa;
    border: none;
    padding: 15px 20px;
    font-size: 20px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .wtf-quantity-btn:hover {
    background: #ff6600;
    color: white;
  }

  .wtf-quantity-number {
    padding: 15px 25px;
    font-size: 18px;
    font-weight: 600;
    border: none;
    text-align: center;
    width: 100px;
  }

  .wtf-add-to-cart {
    width: 100%;
    background: linear-gradient(135deg, #ff6600 0%, #ff8533 100%);
    color: white;
    border: none;
    padding: 20px 30px;
    font-size: 20px;
    font-weight: bold;
    border-radius: 15px;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 6px 20px rgba(255, 102, 0, 0.3);
    margin-bottom: 20px;
  }

  .wtf-add-to-cart:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(255, 102, 0, 0.4);
  }
  .visually-hidden {
    position: absolute !important;
    overflow: hidden;
    clip: rect(0 0 0 0);
    height: 1px;
    width: 1px;
    margin: -1px;
    padding: 0;
    border: 0;
  }

  /* Footer */
  .wtf-footer {
    background: #333;
    color: white;
    padding: 40px 20px;
    text-align: center;
    margin-top: 60px;
  }
  .wtf-footer-content {
    max-width: 1200px;
    margin: 0 auto;
  }
  .wtf-footer h3 {
    color: #ff6600;
    margin-bottom: 20px;
  }
  .wtf-footer p {
    margin-bottom: 10px;
  }

  /* Mobile Responsive */
  @media (max-width: 768px) {
    .wtf-nav-container {
      flex-direction: column;
      gap: 20px;
    }
    .wtf-main-nav {
      gap: 15px;
      flex-wrap: wrap;
      justify-content: center;
    }
    .wtf-product-container {
      grid-template-columns: 1fr;
      gap: 30px;
    }
    .wtf-product-images {
      position: static;
    }
    .wtf-main-image {
      height: 300px;
    }
    .wtf-product-info {
      padding: 25px;
    }
    .wtf-product-title {
      font-size: 28px;
    }
    .wtf-selection-grid {
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    }
    .wtf-flavor-grid {
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
    }
  }
</style>

<header class="wtf-header">
  <div class="wtf-nav-container">
    <div class="wtf-logo-section">
      <div class="wtf-logo-circle">
        <img src="{{ 'wtf-logo.png' | asset_url }}" alt="WTF Logo">
      </div>
      <div class="wtf-logo-text">
        <h1>{{ shop.name | default: 'WTF' }}</h1>
        <p>Welcome To Florida</p>
      </div>
    </div>
    <nav class="wtf-main-nav">
      <a href="{{ routes.root_url }}" class="wtf-nav-link">Home</a>
      <a href="{{ routes.collections_url }}" class="wtf-nav-link">Shop</a>
      <a href="{{ pages['about'].url | default: '#about' }}" class="wtf-nav-link">About</a>
      <a href="{{ pages['contact'].url | default: '#contact' }}" class="wtf-nav-link">Contact</a>
      <a href="{{ routes.cart_url }}" class="wtf-cart-btn"
        >üõí Cart (<span id="wtf-cart-count">{{ cart.item_count }}</span>)</a
      >
    </nav>
  </div>
</header>

<div class="wtf-product-page">
  <a href="{{ collection.url | default: routes.root_url }}" class="wtf-back-button">‚Üê Back to Kratom Teas</a>

  <div class="wtf-product-container">
    <div class="wtf-product-images">
      <div class="wtf-main-image">
        <img src="{{ 'kratom_teas_150x150.png' | asset_url }}" alt="Kratom Tea" id="main-product-image">
      </div>
    </div>

    <div class="wtf-product-info">
      <h1 class="wtf-product-title">Custom Kratom Tea</h1>

      <div class="wtf-product-price">
        <span id="product-price">Starting at $8.00</span>
      </div>

      <div class="wtf-product-description">
        Create your perfect kratom tea with our premium selection of strains and flavors. Choose your size, strain (or
        mix strains), and flavor combination for a personalized experience.
      </div>

      <div class="wtf-selection-section">
        <div class="wtf-selection-title">Choose Your Size</div>
        <div class="wtf-selection-grid">
          <div class="wtf-selection-option">
            <input type="radio" id="size-medium" name="size-selector" value="Medium" data-price="8.00" checked>
            <label for="size-medium"
              >Medium<br>
              <small>12 oz - $8.00</small></label
            >
          </div>
          <div class="wtf-selection-option">
            <input type="radio" id="size-large" name="size-selector" value="Large" data-price="12.00">
            <label for="size-large"
              >Large<br>
              <small>16 oz - $12.00</small></label
            >
          </div>
          <div class="wtf-selection-option">
            <input type="radio" id="size-gallon" name="size-selector" value="Gallon" data-price="45.00">
            <label for="size-gallon"
              >Gallon<br>
              <small>128 oz - $45.00</small></label
            >
          </div>
        </div>
      </div>

      <div class="wtf-selection-section">
        <div class="wtf-selection-title">Choose Your Strain</div>
        <div class="wtf-selection-grid">
          <div class="wtf-selection-option">
            <input type="radio" id="strain-green" name="strain-type-selector" value="Green" checked>
            <label for="strain-green">Green Strain</label>
          </div>
          <div class="wtf-selection-option">
            <input type="radio" id="strain-red" name="strain-type-selector" value="Red">
            <label for="strain-red">Red Strain</label>
          </div>
          <div class="wtf-selection-option">
            <input type="radio" id="strain-white" name="strain-type-selector" value="White">
            <label for="strain-white">White Strain</label>
          </div>
          <div class="wtf-selection-option">
            <input type="radio" id="strain-yellow" name="strain-type-selector" value="Yellow">
            <label for="strain-yellow">Yellow Strain</label>
          </div>
          <div class="wtf-selection-option">
            <input type="radio" id="strain-mix" name="strain-type-selector" value="mix">
            <label for="strain-mix"
              >Mix Strains<br>
              <small>¬Ω & ¬Ω</small></label
            >
          </div>
        </div>

        <div class="wtf-strain-mix" id="strain-mix-options">
          <h4>Choose Your Strain Combination</h4>
          <div class="wtf-strain-row">
            <select class="wtf-strain-select" name="strain-1-selector">
              <option value="Green">Green Strain</option>
              <option value="Red">Red Strain</option>
              <option value="White">White Strain</option>
              <option value="Yellow">Yellow Strain</option>
            </select>
            <span>+</span>
            <select class="wtf-strain-select" name="strain-2-selector">
              <option value="Red">Red Strain</option>
              <option value="Green">Green Strain</option>
              <option value="White">White Strain</option>
              <option value="Yellow">Yellow Strain</option>
            </select>
          </div>
        </div>
      </div>

      <div class="wtf-selection-section">
        <div class="wtf-selection-title">Choose Your Flavors & Pumps</div>
        <div class="wtf-pump-info">
          <p><strong>Pump System:</strong> Medium = 4 pumps, Large = 6 pumps, Gallon = Custom (discuss with staff)</p>
          <p><strong>How it works:</strong> 1 flavor = all pumps of that flavor, 2 flavors = split evenly, etc.</p>
        </div>
        <div class="wtf-flavor-grid">
          {%- assign flavor_list = "lemon,lime,orange,blood orange,strawberry,raspberry,blueberry,coconut,mango,watermelon,simple syrup,sour apple,dragon fruit,blackberry,s'mores,pumpkin spice,cranberry,grenadine,lavender,chocolate,caramel,maple,agave,hazelnut,rose,passion fruit,hibiscus"
            | split: ','
          -%}
          {% for flavor in flavor_list %}
            {% assign flavor_handle = flavor | handleize %}
            <div class="wtf-flavor-option">
              <input
                type="checkbox"
                id="flavor-{{ flavor_handle }}"
                name="flavor-selector"
                value="{{ flavor | escape }}"
              >
              <label for="flavor-{{ flavor_handle }}">{{ flavor | capitalize }}</label>
            </div>
          {% endfor %}
        </div>

        <div class="wtf-pump-display" id="pump-display">
          <h4>Pump Distribution:</h4>
          <div id="pump-breakdown"></div>
        </div>
      </div>

      <div class="wtf-selection-section">
        <div class="wtf-selection-title">Additional Pumps (+$0.50 each)</div>
        <div class="wtf-quantity-controls">
          <div class="wtf-quantity-input">
            <button type="button" class="wtf-quantity-btn" onclick="changeExtraPumps(-1)">‚àí</button>
            <input type="number" value="0" min="0" class="wtf-quantity-number" id="extra-pumps-selector">
            <button type="button" class="wtf-quantity-btn" onclick="changeExtraPumps(1)">+</button>
          </div>
          <span class="wtf-extra-cost" id="extra-pump-cost">+$0.00</span>
        </div>
      </div>

      <div class="wtf-selection-section">
        <div class="wtf-selection-title">Special Requests & Comments</div>
        <textarea
          id="order-comments-selector"
          class="wtf-comments-box"
          placeholder="Any special requests or modifications? We'll try to accommodate!"
        ></textarea>
      </div>

      <form
        id="product-form-kratom"
        class="product-form"
        method="post"
        action="/cart/add"
        enctype="multipart/form-data"
      >
        <input
          type="hidden"
          name="id"
          value="{{ kratom_variant_id }}"
        >

        <div class="wtf-quantity-section">
          <div class="wtf-selection-title">Quantity</div>
          <div class="wtf-quantity-controls">
            <div class="wtf-quantity-input">
              <button type="button" class="wtf-quantity-btn" onclick="changeQuantity(-1)">‚àí</button>
              <input
                id="quantity"
                name="quantity"
                type="number"
                min="1"
                value="1"
                class="wtf-quantity-number"
                inputmode="numeric"
              >
              <button type="button" class="wtf-quantity-btn" onclick="changeQuantity(1)">+</button>
            </div>
          </div>
        </div>

        <input type="hidden" name="properties[Size]" value="Medium" data-line-prop="size">
        <input type="hidden" name="properties[Strain]" value="Green" data-line-prop="strain">
        <input type="hidden" name="properties[Flavors]" value="" data-line-prop="flavors">
        <input type="hidden" name="properties[Pump Distribution]" value="" data-line-prop="pump-distribution">
        <input type="hidden" name="properties[Extra Pumps]" value="0" data-line-prop="extra-pumps">
        <input type="hidden" name="properties[Comments]" value="" data-line-prop="comments">

        <button
          type="submit"
          class="wtf-add-to-cart"
          id="add-to-cart-btn"
          {% unless kratom_variant_id %}
            disabled aria-disabled="true"
          {% endunless %}
        >
          {% if kratom_variant_id %}
            Add to Cart - <span id="cart-price">$8.00</span>
          {% else %}
            Product Unavailable
          {% endif %}
        </button>
      </form>
    </div>
  </div>
</div>

<footer class="wtf-footer">
  <div class="wtf-footer-content">
    <h3>WTF - Welcome To Florida</h3>
    <p>üìç 1520 SE 46th Ln, Unit B, Cape Coral, FL 33904</p>
    <p>‚òéÔ∏è (239) 955-0314</p>
    <p>üåê Premium Kava Bar & Cannabis Products</p>
    <p style="margin-top: 20px; opacity: 0.7;">
      ¬© {{ 'now' | date: '%Y' }}
      {{ shop.name | default: 'WTF Welcome To Florida' }}. All rights reserved.
    </p>
  </div>
</footer>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    // --- CONFIGURATION ---
    const prices = { Medium: 8.0, Large: 12.0, Gallon: 45.0 };
    const pumpCounts = { Medium: 4, Large: 6, Gallon: 'Custom' };

    // --- STATE VARIABLES ---
    let selectedFlavors = [];
    let extraPumps = 0;
    let basePrice = 8.0;

    // --- FORM ELEMENT REFERENCES ---
    const form = document.getElementById('product-form-kratom');

    // --- UI UPDATE FUNCTIONS ---
    function updatePrice() {
      const selectedSize = document.querySelector('input[name="size-selector"]:checked').value;
      basePrice = prices[selectedSize];
      const extraCost = extraPumps * 0.5;
      const totalPrice = basePrice + extraCost;

      document.getElementById('product-price').textContent = `$${totalPrice.toFixed(2)}`;
      document.getElementById('cart-price').textContent = `$${totalPrice.toFixed(2)}`;
      form.querySelector('[data-line-prop="size"]').value = selectedSize;
    }

    function updateStrain() {
      const strainType = document.querySelector('input[name="strain-type-selector"]:checked').value;
      const mixOptions = document.getElementById('strain-mix-options');

      if (strainType === 'mix') {
        mixOptions.classList.add('active');
        const strain1 = document.querySelector('select[name="strain-1-selector"]').value;
        const strain2 = document.querySelector('select[name="strain-2-selector"]').value;
        form.querySelector('[data-line-prop="strain"]').value = `${strain1} + ${strain2}`;
      } else {
        mixOptions.classList.remove('active');
        form.querySelector('[data-line-prop="strain"]').value = strainType;
      }
    }

    function updateFlavors() {
      const checkedFlavors = document.querySelectorAll('input[name="flavor-selector"]:checked');
      selectedFlavors = Array.from(checkedFlavors).map((input) => input.value);

      const selectedSize = document.querySelector('input[name="size-selector"]:checked').value;
      const totalPumps = pumpCounts[selectedSize];

      form.querySelector('[data-line-prop="flavors"]').value = selectedFlavors.join(', ');

      const pumpDisplay = document.getElementById('pump-display');
      const pumpBreakdown = document.getElementById('pump-breakdown');

      if (selectedFlavors.length > 0 && totalPumps !== 'Custom') {
        pumpDisplay.classList.add('active');
        let breakdownText = [];
        let breakdownHTML = [];

        if (selectedFlavors.length === 1) {
          breakdownHTML.push(`<strong>${selectedFlavors[0]}:</strong> ${totalPumps} pumps`);
          breakdownText.push(`${selectedFlavors[0]}: ${totalPumps} pumps`);
        } else {
          const pumpsPerFlavor = Math.floor(totalPumps / selectedFlavors.length);
          const remainingPumps = totalPumps % selectedFlavors.length;

          selectedFlavors.forEach((flavor, index) => {
            const pumps = pumpsPerFlavor + (index < remainingPumps ? 1 : 0);
            breakdownHTML.push(`<strong>${flavor}:</strong> ${pumps} pump${pumps !== 1 ? 's' : ''}`);
            breakdownText.push(`${flavor}: ${pumps} pump${pumps !== 1 ? 's' : ''}`);
          });
        }
        pumpBreakdown.innerHTML = breakdownHTML.join('<br>');
        form.querySelector('[data-line-prop="pump-distribution"]').value = breakdownText.join(', ');
      } else if (totalPumps === 'Custom') {
        pumpDisplay.classList.add('active');
        pumpBreakdown.innerHTML = '<strong>Gallon Size:</strong> Custom pump distribution - discuss with staff';
        form.querySelector('[data-line-prop="pump-distribution"]').value = 'Gallon - Custom (discuss with staff)';
      } else {
        pumpDisplay.classList.remove('active');
        form.querySelector('[data-line-prop="pump-distribution"]').value = '';
      }
    }

    window.changeExtraPumps = function (change) {
      const input = document.getElementById('extra-pumps-selector');
      const current = parseInt(input.value);
      const newVal = Math.max(0, current + change);
      input.value = newVal;
      extraPumps = newVal;

      const extraCost = extraPumps * 0.5;
      document.getElementById('extra-pump-cost').textContent = `+$${extraCost.toFixed(2)}`;
      form.querySelector('[data-line-prop="extra-pumps"]').value = extraPumps;
      updatePrice();
    };

    window.changeQuantity = function (change) {
      const input = document.getElementById('quantity');
      const current = parseInt(input.value);
      const newVal = Math.max(1, current + change);
      input.value = newVal;
    };

    function updateComments() {
      const comments = document.getElementById('order-comments-selector').value;
      form.querySelector('[data-line-prop="comments"]').value = comments;
    }

    // --- FORM SUBMISSION ---
    form.addEventListener('submit', function (e) {
      e.preventDefault();

      if (selectedFlavors.length === 0) {
        alert('Please select at least one flavor.');
        return;
      }

      const formData = new FormData(form);
      const button = document.getElementById('add-to-cart-btn');
      const originalText = button.innerHTML;

      button.textContent = 'Adding...';
      button.disabled = true;

      fetch('/cart/add.js', { method: 'POST', body: formData })
        .then((response) => response.json())
        .then(() => {
          button.textContent = 'Added!';
          return fetch('/cart.js');
        })
        .then((response) => response.json())
        .then((cart) => {
          const cartCountEl = document.getElementById('wtf-cart-count');
          if (cartCountEl) {
            cartCountEl.textContent = cart.item_count;
          }
        })
        .catch((error) => {
          console.error('Error:', error);
          button.textContent = 'Error';
        })
        .finally(() => {
          setTimeout(() => {
            button.innerHTML = originalText;
            button.disabled = false;
          }, 2000);
        });
    });

    // --- INITIALIZE EVENT LISTENERS ---
    document.querySelectorAll('input[name="size-selector"]').forEach((i) =>
      i.addEventListener('change', () => {
        updatePrice();
        updateFlavors();
      })
    );
    document
      .querySelectorAll('input[name="strain-type-selector"]')
      .forEach((i) => i.addEventListener('change', updateStrain));
    document.querySelectorAll('select[name^="strain-"]').forEach((s) => s.addEventListener('change', updateStrain));
    document
      .querySelectorAll('input[name="flavor-selector"]')
      .forEach((i) => i.addEventListener('change', updateFlavors));
    document.getElementById('extra-pumps-selector').addEventListener('input', (e) => {
      extraPumps = parseInt(e.target.value) || 0;
      const extraCost = extraPumps * 0.5;
      document.getElementById('extra-pump-cost').textContent = `+$${extraCost.toFixed(2)}`;
      form.querySelector('[data-line-prop="extra-pumps"]').value = extraPumps;
      updatePrice();
    });
    document.getElementById('order-comments-selector').addEventListener('input', updateComments);

    // Initial updates on page load
    updatePrice();
    updateStrain();
    updateFlavors();
  });
</script>
