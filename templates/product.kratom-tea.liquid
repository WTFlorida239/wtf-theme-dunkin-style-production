{%- comment -%}
  Enhanced Kratom Tea Product Template with AI-Augmented Drink Builder
  Features: Real-time pricing, line item properties, accessibility
{%- endcomment -%}

{%- liquid
  assign current_variant = product.selected_or_first_available_variant
  assign product_form_id = 'product-form-' | append: section.id
  
  # Check product type for conditional logic
  assign is_kratom = product.product_type contains 'Kratom'
  assign is_kava = product.product_type contains 'Kava'  
  assign is_delta9 = product.product_type contains 'Delta-9'
  assign is_gallon = current_variant.title contains 'Gallon'
-%}

<div class="product-main" 
     itemscope 
     itemtype="https://schema.org/Product"
     data-product-id="{{ product.id }}"
     data-product-handle="{{ product.handle }}">
  
  {%- render 'product-media', product: product -%}
  
  <div class="product-info">
    <div class="product-header">
      <h1 class="product-title" itemprop="name">{{ product.title }}</h1>
      
      {%- if product.description != blank -%}
        <div class="product-description" itemprop="description">
          {{ product.description }}
        </div>
      {%- endif -%}
      
      <div class="product-price" 
           id="price-{{ section.id }}" 
           role="status" 
           aria-live="polite">
        {%- render 'price', variant: current_variant, show_compare: true -%}
      </div>
    </div>

    <form action="/cart/add" 
          method="post" 
          enctype="multipart/form-data" 
          id="{{ product_form_id }}"
          class="product-form"
          novalidate="novalidate"
          data-type="add-to-cart-form">
      
      <div class="no-js-hidden">
        <input type="hidden" name="id" value="{{ current_variant.id }}">
        
        {%- unless product.has_only_default_variant -%}
          {%- render 'product-variant-picker', 
              product: product, 
              section: section,
              block: block -%}
        {%- endunless -%}
        
        {%- # Enhanced Drink Builder -%}
        {%- render 'drink-modifier-chips', 
            product: product, 
            is_gallon: is_gallon,
            is_kratom: is_kratom,
            is_kava: is_kava,
            is_delta9: is_delta9 -%}
        
        {%- render 'quantity-input', section: section -%}
        
        <div class="product-form-buttons">
          <button type="submit"
                  name="add"
                  class="btn btn--primary btn--full-width"
                  {% if current_variant.available == false %}disabled{% endif %}
                  aria-describedby="cart-notice-{{ section.id }}">
            <span class="btn-text">
              {%- if current_variant.available -%}
                {{ 'products.product.add_to_cart' | t }}
              {%- else -%}
                {{ 'products.product.sold_out' | t }}
              {%- endif -%}
            </span>
            <div class="loading-overlay__spinner hidden">
              {%- render 'icon-spinner' -%}
            </div>
          </button>
          
          {%- render 'price-upsell', 
              product: product, 
              current_variant: current_variant -%}
        </div>
      </div>
      
      <div class="product-form__error-message-wrapper" 
           role="alert" 
           hidden>
        <svg aria-hidden="true" focusable="false" class="icon icon-error" viewBox="0 0 13 13">
          <circle cx="6.5" cy="6.5" r="5.25" stroke="currentColor" stroke-width="1.25" fill="none"/>
          <path d="m5.227 3.427 1.273 1.273 1.273-1.273a.375.375 0 1 1 .53.53L7.031 4.7l1.272 1.273a.375.375 0 1 1-.53.53L6.5 5.231 5.227 6.504a.375.375 0 1 1-.53-.53L5.969 4.7 4.697 3.427a.375.375 0 1 1 .53-.53Z" fill="currentColor"/>
        </svg>
        <span class="product-form__error-message"></span>
      </div>
    </form>
    
    {%- render 'product-additional-info', product: product -%}
  </div>
</div>

{%- # Enhanced JSON-LD with modifiers -%}
<script type="application/ld+json">
{
  "@context": "https://schema.org/",
  "@type": "Product",
  "name": {{ product.title | json }},
  "image": [
    {%- for media in product.media -%}
      {{ media | image_url: width: 600 | json }}
      {%- unless forloop.last -%},{%- endunless -%}
    {%- endfor -%}
  ],
  "description": {{ product.description | strip_html | json }},
  "brand": {
    "@type": "Brand",
    "name": {{ shop.name | json }}
  },
  "offers": {
    "@type": "AggregateOffer",
    "lowPrice": {{ product.price_min | divided_by: 100.0 | json }},
    "highPrice": {{ product.price_max | divided_by: 100.0 | json }},
    "priceCurrency": {{ cart.currency.iso_code | json }},
    "availability": "https://schema.org/{% if current_variant.available %}InStock{% else %}OutOfStock{% endif %}"
  }
}
</script>

{%- # Analytics Events -%}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Track modifier selections
  document.querySelectorAll('[data-drink-modifier]').forEach(function(modifier) {
    modifier.addEventListener('change', function() {
      if (typeof gtag !== 'undefined') {
        gtag('event', 'modifier_selected', {
          'event_category': 'Drink Builder',
          'event_label': this.dataset.drinkModifier + ':' + this.value,
          'product_id': {{ product.id }}
        });
      }
    });
  });
  
  // Track size upgrades
  document.querySelectorAll('[data-size-upgrade]').forEach(function(upgrade) {
    upgrade.addEventListener('click', function() {
      if (typeof gtag !== 'undefined') {
        gtag('event', 'size_upgrade_clicked', {
          'event_category': 'Upselling',
          'event_label': this.dataset.sizeUpgrade,
          'product_id': {{ product.id }}
        });
      }
    });
  });
});
</script>
